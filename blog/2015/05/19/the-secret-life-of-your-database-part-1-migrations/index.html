
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Secret Life of Your Database, Part 1: Migrations - Words and Code</title>
  <meta name="author" content="Vaidehi Joshi">

  
  <meta name="description" content="As young developers, we often get caught up in what we don&rsquo;t know. One of the first and hardest lessons to learn when you&rsquo;re starting &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://vaidehijoshi.github.io/blog/2015/05/19/the-secret-life-of-your-database-part-1-migrations">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Words and Code" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Words and Code</a></h1>
  
    <h2>One writer&#8217;s journey from words to code.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:vaidehijoshi.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about">About Vaidehi</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">The Secret Life of Your Database, Part 1: Migrations</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-19T08:51:11-04:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:51 am</span></time>
        

<span class="categories">
  
    <a class='category' href='/blog/categories/number-technicaltuesdays/'>#technicaltuesdays</a>, <a class='category' href='/blog/categories/rails/'>rails</a>
  
</span>


        
      </p>
    
  </header>


<div class="entry-content"><p><img src="http://31.media.tumblr.com/tumblr_mcsccsfcnn1qz9l5so1_1280.gif" style="display: block; margin-left: auto; margin-right: auto;"></p>

<p>As young developers, we often get caught up in what we don&rsquo;t know. One of the first and hardest lessons to learn when you&rsquo;re starting out as a programmer is the sheer volume of things that you don&rsquo;t know. You have to get comfortable not knowing them, and you have to work towards learning as much about them as you can.</p>

<p>However, sometimes we focus so much on learning new things, that we forget to come back to what we already know &ndash; or at least, what we <em>think</em> we already know. In fact, this is exactly what I&rsquo;ve been guilty of for the past few weeks. I&rsquo;ve been focusing so much on learning new frameworks and getting comfortable with other languages, that I forgot to question my knowledge of Rails. Since it was a known domain and language, I assumed that I didn&rsquo;t need to revisit it that often.</p>

<p>But boy, was I wrong. Just because you&rsquo;re familiar with something doesn&rsquo;t mean that you understand it completely. The trick to dealing with this is to make yourself feel uncomfortable in your otherwise familiar language. And that&rsquo;s exactly what happened to me. Last week, while writing some lines of SQL (yes, really), I ran across a database migration that used an <code>up</code> and a <code>down</code> method. I saw those lines of code and realized something: I had no idea how my database really works. In fact, I&rsquo;ve written so many migrations in so many Rails applications that, at some point, I&rsquo;ve stopped thinking about what was actually going on under the hood. So, I set out to make myself uncomfortable and uncover the secret life of my database.</p>

<!--more-->


<h2>Teach Me How To Migrate</h2>

<p>Most of us were introduced to Rails databases through migrations. Migrations are how we alter our database schema over time. They implement a Ruby DSL (domain-specific language), and run SQL queries in our database for us. And, they are super easy to learn to use and understand:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">generate</span> <span class="n">migration</span> <span class="no">CreateBooks</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running a command like the one above prompts Active Record to create a unique, timestamped file within our <code>/db</code> directory, with a migration class that might look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:title</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:year</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nothing <em>too</em> surprising here; we&rsquo;ve seen this kind of <code>change</code> method before. But what you may <em>not</em> have seen &ndash; or at least, understood &ndash; is something that looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:title</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:year</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="n">drop_table</span> <span class="ss">:books</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, what does that <code>up</code> and <code>down</code> <em>actually</em> mean? What is going up, exactly&hellip;and what&rsquo;s going down? And how is this different from using the <code>change</code> method, which probably seems way simpler right about now? Well, it&rsquo;s time for us to find out.</p>

<h2>All The Migrations Fit To Run</h2>

<p>The first step to understanding how something works is by unpacking it, step by step. And that&rsquo;s what we&rsquo;ll do with our migrations. Let&rsquo;s first look at how many migrations we currently have.</p>

<p>We&rsquo;ve already generated a few migrations using the <code>rails generate migration</code> commands for our in-progress bookstore application. We can take a look at what all those migrations look like by running the <code>rake db:migrate:status</code> command, which will show us the status of our migrations, including any pending ones we may have:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">❤</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="ss">migrate</span><span class="p">:</span><span class="n">status</span>
</span><span class='line'>
</span><span class='line'><span class="ss">database</span><span class="p">:</span> <span class="n">bookstore_development</span>
</span><span class='line'>
</span><span class='line'> <span class="no">Status</span>   <span class="no">Migration</span> <span class="no">ID</span>    <span class="no">Migration</span> <span class="no">Name</span>
</span><span class='line'><span class="o">--------------------------------------------------</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20140217160517</span>  <span class="no">Create</span> <span class="n">users</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150424175043</span>  <span class="no">Create</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150429145355</span>  <span class="no">Add</span> <span class="n">media</span> <span class="n">columns</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430140850</span>  <span class="no">Add</span> <span class="n">author</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430160704</span>  <span class="no">Add</span> <span class="n">genre</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430192426</span>  <span class="no">Create</span> <span class="n">reading</span> <span class="n">lists</span>
</span><span class='line'>   <span class="n">down</span>   <span class="mi">20150430191950</span>  <span class="no">Add</span> <span class="n">user</span> <span class="nb">id</span> <span class="n">to</span> <span class="n">reading</span> <span class="n">lists</span>
</span></code></pre></td></tr></table></div></figure>


<p>Whoa &ndash; look at all those migrations! And more importantly, look at the column to the left of the migrations: seem familiar? Each one of our migrations has a <code>status</code>, which is either <code>up</code> or <code>down</code>. Let&rsquo;s remember this, we&rsquo;re going to come back to it in a second.</p>

<p>According to the Rails <a href="https://github.com/rails/rails/blob/f47b4236e089b07cb683ee9b7ff8b06111a0ec10/activerecord/lib/active_record/railties/databases.rake#L91">source code</a>, the <code>rake:db:migrate:status</code> rake task displays the status of all our migrations. This can be helpful in determining if we have any migrations we need to run. And it looks like we do! Let&rsquo;s run <code>rake db:migrate</code> and then check the status of our migrations again with <code>rake db:migrate:status</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">❤</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="ss">migrate</span><span class="p">:</span><span class="n">status</span>
</span><span class='line'>
</span><span class='line'><span class="ss">database</span><span class="p">:</span> <span class="n">bookstore_development</span>
</span><span class='line'>
</span><span class='line'> <span class="no">Status</span>   <span class="no">Migration</span> <span class="no">ID</span>    <span class="no">Migration</span> <span class="no">Name</span>
</span><span class='line'><span class="o">--------------------------------------------------</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20140217160517</span>  <span class="no">Create</span> <span class="n">users</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150424175043</span>  <span class="no">Create</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150429145355</span>  <span class="no">Add</span> <span class="n">media</span> <span class="n">columns</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430140850</span>  <span class="no">Add</span> <span class="n">author</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430160704</span>  <span class="no">Add</span> <span class="n">genre</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430192426</span>  <span class="no">Create</span> <span class="n">reading</span> <span class="n">lists</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430191950</span>  <span class="no">Add</span> <span class="n">user</span> <span class="nb">id</span> <span class="n">to</span> <span class="n">reading</span> <span class="n">lists</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hm, interesting. That last migration, which adds a <code>user_id</code> column to our <code>reading_lists</code> table, now has a status of <code>up</code>. We&rsquo;ve basically migrated our database up, meaning that we have no pending migrations and all of our migrations are up to date.</p>

<p>But what if we wanted to rollback our migration, instead? Or, better yet, what if we wanted to rollback the last two migrations? Could we go back in time? Back to when we didn&rsquo;t even have a <code>reading_lists</code> table in our database? How would we do that?</p>

<p>Well, we could run a command like <code>rake db:rollback STEP=</code>, which rolls back our database however many steps we specify. For this example, we&rsquo;ll just rollback to two migrations ago (<code>rake db:rollback STEP=2</code>). What is the state of our database now? Let&rsquo;s check the <code>migrate:status</code> again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">❤</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="ss">migrate</span><span class="p">:</span><span class="n">status</span>
</span><span class='line'>
</span><span class='line'><span class="ss">database</span><span class="p">:</span> <span class="n">bookstore_development</span>
</span><span class='line'>
</span><span class='line'> <span class="no">Status</span>   <span class="no">Migration</span> <span class="no">ID</span>    <span class="no">Migration</span> <span class="no">Name</span>
</span><span class='line'><span class="o">--------------------------------------------------</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20140217160517</span>  <span class="no">Create</span> <span class="n">users</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150424175043</span>  <span class="no">Create</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150429145355</span>  <span class="no">Add</span> <span class="n">media</span> <span class="n">columns</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430140850</span>  <span class="no">Add</span> <span class="n">author</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430160704</span>  <span class="no">Add</span> <span class="n">genre</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">down</span>   <span class="mi">20150430192426</span>  <span class="no">Create</span> <span class="n">reading</span> <span class="n">lists</span>
</span><span class='line'>   <span class="n">down</span>   <span class="mi">20150430191950</span>  <span class="no">Add</span> <span class="n">user</span> <span class="nb">id</span> <span class="n">to</span> <span class="n">reading</span> <span class="n">lists</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nice! We&rsquo;ve migrated our database down, back to two migrations ago. There&rsquo;s some serious <em>Back To The Future</em> stuff going down right now.</p>

<iframe src="//giphy.com/embed/uYfz9FKd0EGpG" width="480" height="255" frameBorder="0" style="max-width: 100%" class="giphy-embed" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>


<p><br></p>

<h2>What Your Database Won&rsquo;t Tell You (Unless You Ask)</h2>

<p>Okay, so we can migrate up and down a database. Cool. We can go back and forth in time, to older versions of our database and to newer &ndash; and even the newest! &ndash; version of our database. Double cool. But what about what we <em>originally</em> set out to figure out? What do the <code>up</code> and <code>down</code> methods do in our migrations? And why do we only see them <em>some</em> of the time?</p>

<p>If you had an inkling that the <code>up</code> and <code>down</code> methods were somehow interlinked with the migration <code>status</code> column we saw when we ran <code>rake db:migrate:status</code>&hellip;well, your inkling was right on the money. They <em>are</em> connected, and in a really cool way.</p>

<p>The <code>up</code> and <code>down</code> methods are defined on a <code>Migration</code> class, which inherits from the <code>ActiveRecord::Migration</code> class. Active Record literally puts the M (model) in MVC, since it&rsquo;s what handles all of our database records. And Active Record is pretty darn smart. Depending on which rake task we provide it, Active Record will execute either an <code>up</code> method in a migration file, or a <code>down</code> method.</p>

<p>The Rails Guides <a href="http://edgeguides.rubyonrails.org/active_record_migrations.html">explain this</a> pretty well:</p>

<blockquote><p>&ldquo;The up method should describe the transformation you&rsquo;d like to make to your schema, and the down method of your migration should revert the transformations done by the up method. In other words, the database schema should be unchanged if you do an up followed by a down. For example, if you create a table in the up method, you should drop it in the down method. It is wise to perform the transformations in precisely the reverse order they were made in the up method.&rdquo;&#8221;</p></blockquote>

<p>As you might have guessed, these two methods are inverse of each other in both form and function. The <code>up</code> method is called when migrating &ldquo;up&rdquo; the database &ndash; <em>forward</em> in time &ndash; while the <code>down</code> method is called when migrating &ldquo;down&rdquo; the database &ndash; or, <em>back</em> in time. In other words, <strong>the <code>up</code> method is a set of directions for running a migration, while the <code>down</code> method is a set of instructions for reverting a migration</strong>. This implies that the code in these two methods should fundamentally do the opposite things of one another.</p>

<p>This also means is that only <em>one</em> of these methods can ever actually run during a migration. If we run <code>rake db:migrate</code>, all of the <code>up</code> methods will execute, and every migration that is currently set to <code>down</code> will change to a status of <code>up</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">❤</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="ss">migrate</span><span class="p">:</span><span class="n">status</span>
</span><span class='line'>
</span><span class='line'><span class="ss">database</span><span class="p">:</span> <span class="n">bookstore_development</span>
</span><span class='line'>
</span><span class='line'> <span class="no">Status</span>   <span class="no">Migration</span> <span class="no">ID</span>    <span class="no">Migration</span> <span class="no">Name</span>
</span><span class='line'><span class="o">--------------------------------------------------</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20140217160517</span>  <span class="no">Create</span> <span class="n">users</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150424175043</span>  <span class="no">Create</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">down</span>   <span class="mi">20150429145355</span>  <span class="no">Add</span> <span class="n">media</span> <span class="n">columns</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">down</span>   <span class="mi">20150430140850</span>  <span class="no">Add</span> <span class="n">author</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">down</span>   <span class="mi">20150430160704</span>  <span class="no">Add</span> <span class="n">genre</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">down</span>   <span class="mi">20150430192426</span>  <span class="no">Create</span> <span class="n">reading</span> <span class="n">lists</span>
</span><span class='line'>   <span class="n">down</span>   <span class="mi">20150430191950</span>  <span class="no">Add</span> <span class="n">user</span> <span class="nb">id</span> <span class="n">to</span> <span class="n">reading</span> <span class="n">lists</span>
</span><span class='line'>
</span><span class='line'><span class="err">❤</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="n">migrate</span>
</span><span class='line'><span class="err">❤</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="ss">migrate</span><span class="p">:</span><span class="n">status</span>
</span><span class='line'>
</span><span class='line'><span class="ss">database</span><span class="p">:</span> <span class="n">bookstore_development</span>
</span><span class='line'>
</span><span class='line'> <span class="no">Status</span>   <span class="no">Migration</span> <span class="no">ID</span>    <span class="no">Migration</span> <span class="no">Name</span>
</span><span class='line'><span class="o">--------------------------------------------------</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20140217160517</span>  <span class="no">Create</span> <span class="n">users</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150424175043</span>  <span class="no">Create</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150429145355</span>  <span class="no">Add</span> <span class="n">media</span> <span class="n">columns</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430140850</span>  <span class="no">Add</span> <span class="n">author</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430160704</span>  <span class="no">Add</span> <span class="n">genre</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430192426</span>  <span class="no">Create</span> <span class="n">reading</span> <span class="n">lists</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430191950</span>  <span class="no">Add</span> <span class="n">user</span> <span class="nb">id</span> <span class="n">to</span> <span class="n">reading</span> <span class="n">lists</span>
</span></code></pre></td></tr></table></div></figure>


<p>And if we run <code>rake db:rollback</code>, the most <em>recent</em> migration that was run (and had its status set to <code>up</code>) will be reverted by calling the <code>down</code> method in the migration file. If we run <code>rake db:rollback STEP=</code>, the <code>down</code> method will be invoked in every migration file we specify we want to rollback (or how many steps back we want to go in the database&rsquo;s history):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">❤</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="ss">migrate</span><span class="p">:</span><span class="n">status</span>
</span><span class='line'>
</span><span class='line'><span class="ss">database</span><span class="p">:</span> <span class="n">bookstore_development</span>
</span><span class='line'>
</span><span class='line'> <span class="no">Status</span>   <span class="no">Migration</span> <span class="no">ID</span>    <span class="no">Migration</span> <span class="no">Name</span>
</span><span class='line'><span class="o">--------------------------------------------------</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20140217160517</span>  <span class="no">Create</span> <span class="n">users</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150424175043</span>  <span class="no">Create</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150429145355</span>  <span class="no">Add</span> <span class="n">media</span> <span class="n">columns</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430140850</span>  <span class="no">Add</span> <span class="n">author</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430160704</span>  <span class="no">Add</span> <span class="n">genre</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430192426</span>  <span class="no">Create</span> <span class="n">reading</span> <span class="n">lists</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430191950</span>  <span class="no">Add</span> <span class="n">user</span> <span class="nb">id</span> <span class="n">to</span> <span class="n">reading</span> <span class="n">lists</span>
</span><span class='line'>
</span><span class='line'><span class="err">❤</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="n">rollback</span> <span class="no">STEP</span><span class="o">=</span><span class="mi">3</span>
</span><span class='line'><span class="err">❤</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="ss">migrate</span><span class="p">:</span><span class="n">status</span>
</span><span class='line'>
</span><span class='line'><span class="ss">database</span><span class="p">:</span> <span class="n">bookstore_development</span>
</span><span class='line'>
</span><span class='line'> <span class="no">Status</span>   <span class="no">Migration</span> <span class="no">ID</span>    <span class="no">Migration</span> <span class="no">Name</span>
</span><span class='line'><span class="o">--------------------------------------------------</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20140217160517</span>  <span class="no">Create</span> <span class="n">users</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150424175043</span>  <span class="no">Create</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150429145355</span>  <span class="no">Add</span> <span class="n">media</span> <span class="n">columns</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430140850</span>  <span class="no">Add</span> <span class="n">author</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">down</span>   <span class="mi">20150430160704</span>  <span class="no">Add</span> <span class="n">genre</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">down</span>   <span class="mi">20150430192426</span>  <span class="no">Create</span> <span class="n">reading</span> <span class="n">lists</span>
</span><span class='line'>   <span class="n">down</span>   <span class="mi">20150430191950</span>  <span class="no">Add</span> <span class="n">user</span> <span class="nb">id</span> <span class="n">to</span> <span class="n">reading</span> <span class="n">lists</span>
</span></code></pre></td></tr></table></div></figure>


<p>And, we could <em>even</em> run or revert a specific migration by giving ActiveRecord the version number/migration id of the migration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">❤</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="ss">migrate</span><span class="p">:</span><span class="n">down</span> <span class="no">VERSION</span><span class="o">=</span><span class="mi">20150429145355</span>
</span><span class='line'><span class="err">❤</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="ss">migrate</span><span class="p">:</span><span class="n">status</span>
</span><span class='line'>
</span><span class='line'><span class="ss">database</span><span class="p">:</span> <span class="n">bookstore_development</span>
</span><span class='line'>
</span><span class='line'> <span class="no">Status</span>   <span class="no">Migration</span> <span class="no">ID</span>    <span class="no">Migration</span> <span class="no">Name</span>
</span><span class='line'><span class="o">--------------------------------------------------</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20140217160517</span>  <span class="no">Create</span> <span class="n">users</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150424175043</span>  <span class="no">Create</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">down</span>   <span class="mi">20150429145355</span>  <span class="no">Add</span> <span class="n">media</span> <span class="n">columns</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430140850</span>  <span class="no">Add</span> <span class="n">author</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430160704</span>  <span class="no">Add</span> <span class="n">genre</span> <span class="n">to</span> <span class="n">books</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430192426</span>  <span class="no">Create</span> <span class="n">reading</span> <span class="n">lists</span>
</span><span class='line'>   <span class="n">up</span>     <span class="mi">20150430191950</span>  <span class="no">Add</span> <span class="n">user</span> <span class="nb">id</span> <span class="n">to</span> <span class="n">reading</span> <span class="n">lists</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the example above, when we ran a <code>migrate:down</code> task, all that was happening is that only the <code>down</code> method written in the &ldquo;AddMediaColumnsToBooks&rdquo; migration file was was invoked!</p>

<iframe src="//giphy.com/embed/i2gzQAinKY3hS" width="480" height="264" frameBorder="0" style="max-width: 100%" class="giphy-embed" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>


<p><br></p>

<p>Neat, right!? Or maybe just kind of mind-blowing if you&rsquo;ve never seen this before. Who knew that this is what migrations were really all about? Well, now you and I both know, so that&rsquo;s pretty rad.</p>

<h2>Why Change When You Can Go Up And Down?</h2>

<p>The <code>change</code> method is pretty standard when it comes to migrations partly because it&rsquo;s a newer addition to Rails. Just like <code>up</code> and <code>down</code>, the <code>change</code> method is defined on the <code>ActiveRecord::Migration</code> class. In fact, it does exactly what <code>up</code> and <code>down</code> accomplish together. The <code>change</code> method is <em>usually</em> able to automatically figure out the inverse operation you provide it; for example, if you call <code>create_table</code> inside of the <code>change</code> method, when you run <code>rake db:rollback</code>, it will <code>drop_table</code>. The same goes for <code>add_column</code> and <code>remove_column</code>.</p>

<p>So, if the <code>change</code> method can do all of these things in one go (rather than in two methods), why do we sometimes see an <code>up</code> and <code>down</code> method defined together in a migration file?</p>

<p>Well, there are many times when we might want Active Record to be smart and figure out when to drop a column or table. But other times, it might not be as clear.</p>

<p>For example, what if we wanted a migration that just created or fixed data? We wouldn&rsquo;t want ActiveRecord to try to figure out whether to add or remove a column&hellip;or worse, drop our table! Or what if we wanted to remove columns when we migrated up, and <em>add</em> columns when we migrated down? We&rsquo;d have to specify that explicitly in our <code>up</code> and <code>down</code> methods.</p>

<p>We could even get fancy with some SQL and do something a bit more granular like rename a table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">RenameReadingListsToWishLists</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span>
</span><span class='line'><span class="sh">      ALTER TABLE reading_lists</span>
</span><span class='line'><span class="sh">        RENAME TO wish_lists;</span>
</span><span class='line'><span class="no">    SQL</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span>
</span><span class='line'><span class="sh">      ALTER TABLE wish_lists</span>
</span><span class='line'><span class="sh">        RENAME TO reading_lists;</span>
</span><span class='line'><span class="no">    SQL</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this example, we&rsquo;re using the <code>execute</code> method, which takes either a string value of a SQL query, or a heredoc like the one we&rsquo;ve written above.</p>

<p>And we might even want to make it completely impossible for someone to ever revert a migration. We could specify that kind of behavior in our <code>down</code> method by raising an ActiveRecord error:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>  <span class="k">raise</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">IrreversibleMigration</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Depending on which migration file this <code>down</code> method lived in, that migration could never be &ldquo;migrated down&rdquo;. This can sometimes be dangerous, but also useful &ndash; particularly if we had many other data models that were depending on those tables existing in the first place!</p>

<p>It turns out that our database is a pretty powerful thing. Rails provides us with a lot of functionality and flexibility of moulding it to be exactly the way that we want it to be. It&rsquo;s just up to us to take advantage of it in the right situations! The more we learn about shaping our database, the better equipped we&rsquo;ll be to creating effective, concise, and streamlined databases for each and every one of our applications.</p>

<p>But the truth is, we&rsquo;ve only scratched the surface of databases today. Tune in again next week, when I&rsquo;ll uncover the secret life of all your&hellip;JOIN TABLES! Try and contain your enthusiasm, my friends.</p>

<iframe src="//giphy.com/embed/2yAjmbCfYcQUw" width="480" height="293" frameBorder="0" style="max-width: 100%" class="giphy-embed" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>


<h2>tl;dr?</h2>

<ul>
<li>The <code>up</code> and <code>down</code> methods are a more granular way of defining the <code>change</code> method in a Rails migration. The <code>up</code> method is a set of instructions of what to do when you migrate, and the <code>down</code> method is a set of directions of what to do when you rollback.</li>
<li>Want to see more examples of when you might want to use the <code>up</code> and <code>down</code> methods in place of the <code>change</code> method? Check out the Rails Guides on <a href="http://api.rubyonrails.org/classes/ActiveRecord/Migration.html">Active Record Migrations</a>.</li>
<li>Need to read more on running migrations? <a href="http://guides.rubyonrails.org/v2.3.11/migrations.html#running-migrations">Read this</a>. Gotta brush up on migrations after reading this post? Head over <a href="http://edgeguides.rubyonrails.org/active_record_migrations.html">here</a>.</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Vaidehi Joshi</span></span>

      




<time class='entry-date' datetime='2015-05-19T08:51:11-04:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:51 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/number-technicaltuesdays/'>#technicaltuesdays</a>, <a class='category' href='/blog/categories/rails/'>rails</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://vaidehijoshi.github.io/blog/2015/05/19/the-secret-life-of-your-database-part-1-migrations/" data-via="" data-counturl="http://vaidehijoshi.github.io/blog/2015/05/19/the-secret-life-of-your-database-part-1-migrations/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/05/12/investigating-rubys-global-functions-plus-kernel-module-with-puts/" title="Previous Post: Investigating Ruby's Global Functions + Kernel Module With puts">&laquo; Investigating Ruby&#8217;s Global Functions + Kernel Module With puts</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/05/26/the-secret-life-of-your-database-part-2-join-tables/" title="Next Post: The Secret Life Of Your Database, Part 2: Join Tables">The Secret Life Of Your Database, Part 2: Join Tables &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/06/09/refactoring-to-reveal-rails-group-by/">Refactoring to Reveal Rails Group_by</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/02/code-smells-and-ruby-shorthand-unpacking-ampersand-plus-to-proc/">Code Smells and Ruby Shorthand: Unpacking Ampersand + To_proc</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/26/the-secret-life-of-your-database-part-2-join-tables/">The Secret Life of Your Database, Part 2: Join Tables</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/19/the-secret-life-of-your-database-part-1-migrations/">The Secret Life of Your Database, Part 1: Migrations</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/12/investigating-rubys-global-functions-plus-kernel-module-with-puts/">Investigating Ruby&#8217;s Global Functions + Kernel Module With Puts</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Vaidehi Joshi -
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
